name: Deploy Namespace Policies

on:
  push:
    branches:
      - main  # or your desired branch
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get AKS Credentials
      run: |
        az aks get-credentials --resource-group YOUR_RESOURCE_GROUP --name YOUR_AKS_CLUSTER --overwrite-existing

    - name: Set up Helm
      uses: azure/setup-helm@v3

    - name: Install Gatekeeper via Helm
      run: |
        helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
        helm repo update
        helm install gatekeeper gatekeeper/gatekeeper --namespace gatekeeper-system --create-namespace

    - name: Apply Constraint Template
      run: kubectl apply -f constraintemplates.yaml

    - name: Apply Constraints
      run: kubectl apply -f constraints.yaml

    - name: Install Namespace Governance Policy
      run: |
        helm install namespace-governance ./accion-gatekeeper-namespace-policy -f values.yaml
